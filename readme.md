# strace-php-fpm

blog: https://blog.shin1x1.com/entry/strace-php-fpm

php-fpm から発行されるシステムトレースを確認する Docker Compose 環境です。
strace コマンドで php-fpm を起動して、php-fpm プロセスから fork されるワーカープロセスを含めて発行されるシステムコールをログファイルに記録します。

ログファイルを見ることで、php-fpm から発行されるシステムコールが確認できます。

⚠️本リポジトリは開発環境での利用を想定しています。本番環境では利用しないでください。

## Usage

### php-fpm 起動

make コマンドを実行すると docker compose コマンドが実行され、php-fpm が起動します。

```shell
$ make
```

ブラウザで http://localhost:8000 にアクセスすると Laravel の画面が表示されます。

### システムコールの確認

php-fpm は strace コマンドから実行されていますので、下記ファイルに発行されるシステムコールが追記されていきます。

- laravel/storage/logs/trace.txt

```shell
$ head laravel/storage/logs/trace.txt
9     02:19:46.679857 execve("/usr/local/sbin/php-fpm", ["php-fpm"], 0xffffe0460808 /* 14 vars */) = 0 <0.001066>
9     02:19:46.681809 brk(NULL)         = 0xaaaac9abb000 <0.000021>
9     02:19:46.682124 mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xffffacab2000 <0.000029>
9     02:19:46.682511 faccessat(AT_FDCWD</var/www/html>, "/etc/ld.so.preload", R_OK) = -1 ENOENT (No such file or directory) <0.000053>
9     02:19:46.683170 openat(AT_FDCWD</var/www/html>, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3</etc/ld.so.cache> <0.000034>
9     02:19:46.683477 newfstatat(3</etc/ld.so.cache>, "", {st_mode=S_IFREG|0644, st_size=11602, ...}, AT_EMPTY_PATH) = 0 <0.000021>
9     02:19:46.683741 mmap(NULL, 11602, PROT_READ, MAP_PRIVATE, 3</etc/ld.so.cache>, 0) = 0xffffacaaf000 <0.000048>
9     02:19:46.684157 close(3</etc/ld.so.cache>) = 0 <0.000034>
9     02:19:46.684535 openat(AT_FDCWD</var/www/html>, "/lib/aarch64-linux-gnu/libreadline.so.8", O_RDONLY|O_CLOEXEC) = 3</usr/lib/aarch64-linux-gnu/libreadline.so.8.2> <0.000054>
9     02:19:46.684938 read(3</usr/lib/aarch64-linux-gnu/libreadline.so.8.2>, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0\267\0\1\0\0\0\0\0\0\0\0\0\0\0@\0\0\0\0\0\0\0\240b\6\0\0\0\0\0\0\0\0\0@\08\0\7\0@\0\32\0\31\0\1\0\0\0\5\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0D\t\5\0\0\0\0\0D\t\5\0\0\0\0\0\0\0\1\0\0\0\0\0\1\0\0\0\6\0\0\0\0\343\5\0\0\0\0\0\0\343\6\0\0\0\0\0\0\343\6\0\0\0\0\0x~\0\0\0\0\0\0\340\224\0\0\0\0\0\0\0\0\1\0\0\0\0\0\2\0\0\0\6\0\0\0\0\365\5\0\0\0\0\0\0\365\6\0\0\0\0\0\0\365\6\0\0\0\0\0\360\1\0\0\0\0\0\0\360\1\0\0\0\0\0\0\10\0\0\0\0\0\0\0\4\0\0\0\4\0\0\0\310\1\0\0\0\0\0\0\310\1\0\0\0\0\0\0\310\1\0\0\0\0\0\0$\0\0\0\0\0\0\0$\0\0\0\0\0\0\0\4\0\0\0\0\0\0\0P\345td\4\0\0\0\244~\4\0\0\0\0\0\244~\4\0\0\0\0\0\244~\4\0\0\0\0\0L\23\0\0\0\0\0\0L\23\0\0\0\0\0\0\4\0\0\0\0\0\0\0Q\345td\6\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\20\0\0\0\0\0\0\0R\345td\4\0\0\0\0\343\5\0\0\0\0\0\0\343\6\0\0\0\0\0\0\343\6\0\0\0\0\0\0\35\0\0\0\0\0\0\0\35\0\0\0\0\0\0\1\0\0\0\0\0\0\0\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\343*\37\0-\226\6\302\3302\274\222\237\23\255\235\212_\1\\\0\0\0\0\t\2\0\0v\0\0\0@\0\0\0\f\0\0\0,0!\0%\0\f@\10  \10A\21f`r\00143Fs\212\v\210!\6D\21Dj\240\2 (FJ\210\3026\240\310\2\210\"\205\236\257\0C\224C\1\1i\n\204\1\200I\333\270\3644\215/\201\4\10\2\0\r\30\6\2,R\211\376\204G\306\244X\214P \316A!1[\3\0&iL`\373\250\22\10\202\7\24\0\2250\322\23646\24\0\2\n\226\26\200\10\0\1,\0!\7,\f\204\35\372\300\331\1\4\3 \220\215\333\5\201\4e$\244\1(\23\3 \0\253\t\266\362\340p\0!\0a\303\"\0\0Q\r#\4\10\256\236\0\222\304\1\10\f\4\201:u\1\250\354j\307z\32a\5\4\6\1\240\200\220\0h\343\n)(4\216\223\20\f\f\202\5N%\n\242\0160\0MC\1\200\21a \0003\f\5\21X\276Ai;Q\314&\0\311&b\201\303\300\0\f\26\204\202@D\3016\261\240\360\231x\260|\0\21\332*\316(\244\210\25a\2\200\200\200\300\r\0016\30\304\3111\4J0  \260z\5FH\260\10\253Q\6\34\316(\320A\21\4\340 \0\0\202DB@R#\n '\204", 832) = 832 <0.000034>
```

このファイルには php-fpm が発行するシステムコールが記録し続けますので、不要になったら終了してください。

### php-fpm 終了

終了する場合は、make clean コマンドを実行します。このコマンドを実行すると laravel/storage/logs/trace.txt は削除されます。

```shell
$ make clean
```

### PHP 拡張

php-fpm の挙動が確認しやすいように、OPcache と Xdebug は無効にしています。

これらを有効にする場合、compose.yaml の下記をコメントアウトしてください。

```yaml
      # Comment out if you want to enable OPcache
      - ./docker/php-fpm/docker-php-ext-opcache.ini:/usr/local/etc/php/conf.d/docker-php-ext-opcache.ini
      # Comment out if you want to enable Xdebug
      - ./docker/php-fpm/docker-php-ext-xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
```
